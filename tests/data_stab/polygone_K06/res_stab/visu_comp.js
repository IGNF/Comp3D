//Comp3D visualization
//Copyright 2013-2018 IGN-Travaux Spéciaux jean-michael.muller@ign.fr paul.bouquet@ign.fr
var translation_en={
  "Comp3D - Rapport de calcul": "Comp3D - Computation report",
  "Compensation": "Compensation",
  "Simulation propagation": "Simulation propagation",
  "Simulation Monte-Carlo": "Simulation Monte-Carlo",
  "radians": "rad",
  "grades": "grad",
  "degrés": "deg",
  "DMS": "DMS",
  "Oui": "Yes",
  "Non": "No",
  "Afficher les messages lors de la lecture des fichiers": "Show file reading messages",
  "Masquer les messages lors de la lecture des fichiers": "Hide file reading messages",
  "Afficher les messages lors du paramétrage du calcul": "Show computation configuration messages",
  "Masquer les messages lors du paramétrage du calcul": "Hide computation configuration messages",
  "Afficher les messages lors de la lecture de la configuration": "Show configuration file reading messages",
  "Masquer les messages lors de la lecture de la configuration": "Hide configuration file reading messages",
  "Afficher les messages lors du calcul": "Show computation messages",
  "Masquer les messages lors du calcul": "Hide computation messages",
  "Configuration du chantier": "Project configuration",
  "Nom": "Name",
  "Description": "Description",
  "Fichier COR racine": "Root COR file",
  "Fichier de coordonnées principal": "",
  "Fichier OBS racine": "Root OBS file",
  "Fichier d&apos;observation principal": "Main observation file",
  "Unité": "Unit",
  "Nombre de chiffres significatifs": "Significant digits number",
  "c&apos;est un indice de la précision donnée dans le rapport, certaines valeurs seront données avec plus ou moins de décimales": "clue for the precision given in the report, some value are given with less or more decimal places",
  "Type de calcul": "Computation nature",
  "Inversion de la matrice normale": "Normal matrix inversion",
  "Nécessaire pour obtenir des intervalles et ellipsoïdes de confiance et obtenir les informations de redondance": "Required to get confidence intervalls and ellipsoids and get redondancy informations",
  "Contraintes internes": "Internal contraints",
  "Coefficient de réfraction": "Refraction coefficient",
  "N&apos;affecte que les mesures zénithales": "Just impact vertical angle measures",
  "Latitude centrale": "Center latitude",
  "Latitude permettant de déterminer la courbure locale de l&apos;ellipsoïde": "Latitude to determine the local curvature of the ellipsoid",
  "Module linéaire": "Point scale",
  "Module linéaire moyen du chantier": "Project mean local scale",
  "Centre des coordonnées locales": "Local coordinates center",
  "Critère de convergence": "Convergence criterion",
  "Différence de σ0 entre 2 itérations": "σ0 difference between 2 iterations",
  "Itérations maximum": "Maxium iterations",
  "Itérations forcées": "Forced iterations",
  "Nombre d&apos;itérations forcées après convergence": "Forced iteration number after convergence",
  "Informations sur le calcul": "Computation information",
  "Compensation effectuée": "Compensation done",
  "&sigma;0 initial": "Initial &sigma;0",
  "&sigma;0 final": "Final &sigma;0",
  "Itérations": "Iterations",
  "Interruption du calcul": "Computation interruption",
  "Début du calcul": "Computation start",
  "Durée du calcul": "Computation duration",
  "Rayon de la sphère": "Sphere radius",
  "Nombre d'observations total": "Total observations number",
  "Nombre d'observations actives": "Active observations number",
  "Paramètres": "Parameters",
  "Évolution du &sigma;0": "&sigma;0 evolution",
  "Iteration": "Iteration",
  "Test du &#935;²": "&#935;² test",
  "Test du &#935;² : ": "&#935;² test: ",
  "Confiance : ": "Confidence: ",
  "Degrés de liberté : ": "Degrees of freedom: ",
  "Test : ": "Test: ",
  "Test réussi : ": "Test passed : ",
  "Coordonnées initiales": "Initial coordinates",
  "X init": "X init",
  "Y init": "Y init",
  "Z init": "Z init",
  "&sigma;X init": "&sigma;X init",
  "&sigma;Y init": "&sigma;Y init",
  "&sigma;Z init": "&sigma;Z init",
  "Obs actives": "Active obs",
  "Nombre d&apos;observations actives en lien avec le point": "Active observations number linked to the point",
  "Observations": "Observations",
  "Code": "Code",
  "Type d&apos;observation": "Observation type",
  "Provenance de la mesure": "Mesure provenance",
  "De": "From",
  "Point visé": "Targeted point",
  "Vers": "To",
  "Mesure": "Measure",
  "Observation": "Observation",
  "Distance": "Distance",
  "Distance entre les coordonnées compensées des 2 points": "Distance between adjusted coordinates of the two points",
  "Sigma absolu + sigma relatif": "absolute sigma + relative sigma",
  "&sigma; total": "total &sigma;",
  "Sigma sur l&apos;observation obtenue après compensation": "observation sigma after adjusted",
  "&sigma; a posteriori": "A posteriori &sigma;",
  "Résidu": "Residual",
  "Écart entre l&apos;observation compensée et l&apos;observation mesurée": "difference between adjusted and measured obervations",
  "Résidu normalisé": "Normalized residual",
  "Résidu divisé par le sigma total": "redisual divided by total sigma",
  "0% : observation indispensable / 100% : observation inutile": "0%: indispensable observation / 100%: unnecessary observation",
  "Redondance": "Redondancy",
  "Répartition des résidus": "Residual repartition",
  "Standard": "Standard",
  "Tous les résidus": "All residuals",
  "Répartition des résidus normalisés": "Normalized residuals repartition",
  "Horizontales": "Horizontal",
  "Zénithales": "Zenithal",
  "Distances": "Distances",
  "Bascules": "Similarities",
  "Coord": "Coord",
  "Dénivelés": "Direct levelling",
  "Répartition des résidus normalisés par type": "Type-based normalized residuals repartition",
  "Résidus absolus moyens par rapport à la distance": "Average distance-relative normalized absolute residuals repartition",
  "Plus gros résidus": "Biggest residuals",
  "les 20 plus gros résidus normalisés du plus grand au plus petit": "20 biggest normalized residuals",
  "Nom fichier": "File name",
  "Point origine": "Origin point",
  "Verticale": "Vertical",
  "Coordonnées cartésiennes globales": "Global cartesian coordinates",
  "Erreur": "Error",
  "Coordonnées compensées": "Compensated coordinates",
  "X comp": "X comp",
  "Y comp": "Y comp",
  "Z comp": "Z comp",
  "&Delta;X": "&Delta;X",
  "&Delta;Y": "&Delta;Y",
  "&Delta;Z": "&Delta;Z",
  "Ellipsoïdes de confiance": "Confidence ellipsoids",
  "1/2 Axe (mm)": "1/2 Axis (mm)",
  "Azimut (gr)": "Azimuth (gr)",
  "Site (gr)": "Tilt (gr)",
  "Intervalles de confiance": "Confidence intervals",
  "Intervalles de confiance 1D à 1 𝜎 (68%)": "1D 1 𝜎 confidence intervals (68%)",
  "&sigma;X (mm)": "&sigma;X (mm)",
  "&sigma;Y (mm)": "&sigma;Y (mm)",
  "&sigma;Z (mm)": "&sigma;Z (mm)",
  "Simulation des déplacements des points": "Points displacements simulation",
  "Pour ": "For ",
  " simulations :": " simulations:",
  "EMQ X (mm)": "MSE X (mm)",
  "EMQ Y (mm)": "MSE Y (mm)",
  "EMQ Z (mm)": "MSE Z (mm)",
  "Max X (mm)": "Max X (mm)",
  "Max Y (mm)": "Max Y (mm)",
  "Max Z (mm)": "Max Z (mm)",
  "Sommaire": "Summary",
}
//------------------------------------------------------------------------------
// begin simple_i18n functions
//------------------------------------------------------------------------------
var translations = {
  // update list of translations here, example: "fr":translation_fr,
  "en": translation_en,
};
//choose the translation here
current_dict = {};
function _(key) {
  if (key in current_dict)
    return current_dict[key]
  return key;
}
// end simple_i18n functions

//------------------------------------------------------------------------------
// Déclarations des variables
//------------------------------------------------------------------------------
var type_calcul = {
  "0": _("Compensation"),
  "1": _("Simulation propagation"),
  "2": _("Simulation Monte-Carlo")
};
var unit = {
  "0": _("radians"),
  "1": _("grades"),
  "2": _("degrés"),
  "3": _("DMS")
};
var codes_obs = {
  "-1": "coord_x",
  "-2": "coord_y",
  "-3": "coord_z",
  "1": "dist",
  "2": "dist hz",
  "3": "dist",
  "4": "den",
  "5": "hz",
  "6": "zen",
  "7": "tour",
  "8": "gis",
  "9": "center_meta",
  "10": "photo",
  "11": "scanner",
  "12": "tracker",
  "13": "align",
  "91": "center_x",
  "92": "center_y",
  "101": "bascule_x",
  "102": "bascule_y",
  "103": "bascule_z",
  "104": "bascule_hz",
  "105": "bascule_zen",
  "106": "bascule_dist",

  "201": "cint_tx",
  "202": "cint_ty",
  "203": "cint_tz",
  "204": "cint_rx",
  "205": "cint_ry",
  "206": "cint_rz",
  "207": "cint_sc",
};

var parite = ["paire", ""];
var max_biggest_residuals = 20;
var items;
var all_pts = [];
var all_files = [];
var all_obs = [];
var all_basc = [];
var all_active_obs = [];
//variables to know if obs type exist for graph
var exist_hz = false;
var exist_zen = false;
var exist_dist = false;
var exist_basc = false;
var exist_coord = false;
var exist_den = false;

function bool(result){
    if (result) return _("Oui");
    else return _("Non");
}
//------------------------------------------------------------------------------
// Fonctions used in the different parts
//------------------------------------------------------------------------------
function displayMessagesRead() {
  if (document.getElementById("messages_read_data").style.display == "block")
  {
    document.getElementById('messages_read_data').style.display = 'none';
    document.getElementById('messageRead').style.fontWeight = 'normal';
    document.getElementById("messageRead").value = _("Afficher les messages lors de la lecture des fichiers");
  }
  else
  {
    document.getElementById('messages_read_data').style.display = 'block';
    document.getElementById('messageRead').style.fontWeight = 'bold';
    document.getElementById("messageRead").value = _("Masquer les messages lors de la lecture des fichiers");
  }
}
function displayMessagesLeast_squares() {
  if (document.getElementById("messages_set_least_squares").style.display == "block")
  {
    document.getElementById('messages_set_least_squares').style.display = 'none';
    document.getElementById('messageLeast').style.fontWeight = 'normal';
    document.getElementById("messageLeast").value = _("Afficher les messages lors du paramétrage du calcul");
  }
  else
  {
    document.getElementById('messages_set_least_squares').style.display = 'block';
    document.getElementById('messageLeast').style.fontWeight = 'bold';
    document.getElementById("messageLeast").value = _("Masquer les messages lors du paramétrage du calcul");
  }
}
function displayMessagesReadConfig() {
  if (document.getElementById("messages_read_config").style.display == "block")
  {
    document.getElementById('messages_read_config').style.display = 'none';
    document.getElementById('messageReadC').style.fontWeight = 'normal';
    document.getElementById("messageReadC").value = _("Afficher les messages lors de la lecture de la configuration");
  }
  else
  {
    document.getElementById('messages_read_config').style.display = 'block';
    document.getElementById("messageReadC").value = _("Masquer les messages lors de la lecture de la configuration");
    document.getElementById('messageReadC').style.fontWeight = 'bold';
  }
}
function displayMessagesComputation() {
  if (document.getElementById("messages_computation").style.display == "block")
  {
    document.getElementById('messages_computation').style.display = 'none';
    document.getElementById('messageComputation').style.fontWeight = 'normal';
    document.getElementById("messageComputation").value = _("Afficher les messages lors du calcul");
  }
  else
  {
    document.getElementById('messages_computation').style.display = 'block';
    document.getElementById('messageComputation').style.fontWeight = 'bold';
    document.getElementById("messageComputation").value = _("Masquer les messages lors du calcul");
  }
}
function pointSortFunction(p1, p2) {//make points and obs lists
  if (p1.number > p2.number)
    return 1
  else if (p1.number < p2.number)
    return -1
  else return 0;
}
function obsSortFunction(o1, o2) {
  if (o1.number > o2.number)
    return 1
  else if (o1.number < o2.number)
    return -1
  else return 0;
}
function residualSortFunction(o1, o2) {
  if (Math.abs(o1.normalized_residual) < Math.abs(o2.normalized_residual))
    return 1
  else if (Math.abs(o1.normalized_residual) > Math.abs(o2.normalized_residual))
    return -1
  else return 0;
}
function point_sigmas(pt) {
   //affiche les sigmas des points en fonction de leur type (3D ou 1D libre ou fixé) et gère la mise en forme en fonction de leur signe
    if (pt.code === 1)
      return ('<td class="'+((parseFloat(pt.sigmas_init[0])<0)?"inactive":"")+'">' + parseFloat(pt.sigmas_init[0]).toFixed(num_decimales) + 
        '</td><td class="'+((parseFloat(pt.sigmas_init[1])<0)?"inactive":"")+'">' + parseFloat(pt.sigmas_init[1]).toFixed(num_decimales) + 
        '</td><td class="'+((parseFloat(pt.sigmas_init[2])<0)?"inactive":"")+'">' + parseFloat(pt.sigmas_init[2]).toFixed(num_decimales) + '</td>');
    else if (pt.code === 2)
      return ('<td class="'+((parseFloat(pt.sigmas_init[0])<0)?"inactive":"")+'">' + parseFloat(pt.sigmas_init[0]).toFixed(num_decimales) + 
         '</td><td class="'+((parseFloat(pt.sigmas_init[1])<0)?"inactive":"")+'">' + parseFloat(pt.sigmas_init[1]).toFixed(num_decimales) + 
         '</td><td>' + '</td>');
    else if (pt.code === 3)
      return ('<td>' +
        '</td><td>' +
        '</td><td class="'+((parseFloat(pt.sigmas_init[2])<0)?"inactive":"")+'">' + parseFloat(pt.sigmas_init[2]).toFixed(num_decimales) + '</td>');
    else if (pt.code === 4)
      return ('<td>-' +
        '</td><td>-' +
        '</td><td></td>');
    else if (pt.code === 5)
      return ('<td>-' +
        '</td><td>-' +
        '</td><td class="'+((parseFloat(pt.sigmas_init[2])<0)?"inactive":"")+'">' + parseFloat(pt.sigmas_init[2]).toFixed(num_decimales) + '</td>');
    else return ('<td></td><td></td><td></td>');
}

//------------------------------------------------------------------------------
// Fonctions d'affichage des parties et de l'entrée associée dans le sommaire
//------------------------------------------------------------------------------
function show_version(){
  document.title=_('Comp3D - Rapport de calcul'); 
  //Version de Comp3D ------------------------------------------------------------------------------------
  $("<p/>", {
    text: 'Version : ' + data["COMP3D_VERSION"],
    id: 'version'
  }).appendTo('body');
  $("<p/>", {
    text: 'Commit : ' + data["COMP3D_COMMIT"],
    id: 'commit'
  }).appendTo('body');
  $("<p/>", {
    text: 'Options : ' + data["COMP3D_OPTIONS"],
    id: 'options'
  }).appendTo('body');
}
function show_info_work(){
  //Configuration du chantier ------------------------------------------------------------------------------------
  $("<p/>").html('<a href="#info_work">' + _('Configuration du chantier') + '</a>').appendTo('#sommaire');
  $("<h2/>", {
    text: _('Configuration du chantier'),
    id: 'info_work'
  }).appendTo('#rapport');
  $("<a/>", {
    href: '#top'
  }).html('&#8593;').appendTo('#info_work');
  items=[];

  items.push("<dt>" + _("Nom") + " :</dt>");
  if (data["config"]["name"]===""){
    items.push("<dd>-</dd>");
  }else{
    items.push("<dd>" + data["config"]["name"] + "</dd>");
  }

  items.push("<dt>" + _("Description") + " :</dt>");
  if (data["config"]["description"]===""){
    items.push("<dd>-</dd>");
  }else{
    items.push("<dd>" + data["config"]["description"] + "</dd>");
  }
  items.push("<dt title='"+_('Fichier de coordonnées principal')+"'>" + _("Fichier COR racine") + " :</dt><dd>" + data["config"]["root_COR_file"] + '</dd>');
  items.push("<dt title='"+_('Fichier d&apos;observation principal')+"'>" + _("Fichier OBS racine") + " :</dt><dd>" + data["config"]["root_OBS_file"] + '</dd>');
  items.push("<dt>" + _("Unité") + " :</dt><dd>" + unit[data["config"]["files_unit"]] + '</dd>');
  items.push("<dt title='"+_('c&apos;est un indice de la précision donnée dans le rapport, certaines valeurs seront données avec plus ou moins de décimales')+"'>" + _("Nombre de chiffres significatifs") + " :</dt><dd>" + parseInt(data["config"]["nb_digits"]) + '</dd>');
  items.push("<dt>" + _("Type de calcul") + " :</dt><dd>" + type_calcul[data["config"]["compute_type"]] + '</dd>');
  if (data["config"]["compute_type"] == 0)
      items.push("<dt title='"+_('Nécessaire pour obtenir des intervalles et ellipsoïdes de confiance et obtenir les informations de redondance')+"'>" + _("Inversion de la matrice normale") + " :</dt><dd>" + bool(data["config"]["invert_matrix"]) + '</dd>');
  if (data["config"]["compute_type"] != 2)
      items.push("<dt>" + _("Contraintes internes") + " :</dt><dd>" + bool(data["config"]["internal_constraints"]) + '</dd>');
  items.push("<dt title='"+_('N&apos;affecte que les mesures zénithales')+"'>" + _("Coefficient de réfraction") + " :</dt><dd>" + parseFloat(data["config"]["refraction"]).toFixed(num_decimales) + '</dd>');
  items.push("<dt title='"+_('Latitude permettant de déterminer la courbure locale de l&apos;ellipsoïde')+"'>" + _("Latitude centrale") + " :</dt><dd>" + parseFloat(data["config"]["center_latitude"]).toFixed(1) + '</dd>');
  items.push("<dt title='"+_('Module linéaire moyen du chantier')+"'>" + _("Module linéaire") + " :</dt><dd>" + parseFloat(data["config"]["local_scale"]).toFixed(6) + '</dd>');
  items.push("<dt>" + _("Centre des coordonnées locales") + " :</dt><dd>" +
    "X=" + parseFloat(data["config"]["local_center"][0]).toFixed(0) + " " +
    "Y=" + parseFloat(data["config"]["local_center"][1]).toFixed(0) + '</dd>');
  items.push("<dt title='"+_('Différence de σ0 entre 2 itérations')+"'>" + _("Critère de convergence") + " :</dt><dd>" + parseFloat(data["config"]["convergence_criterion"]).toFixed(6) + '</dd>');
  items.push("<dt>" + _("Itérations maximum") + " :</dt><dd>" + parseInt(data["config"]["max_iterations"]) + '</dd>');
  items.push("<dt title='"+_('Nombre d&apos;itérations forcées après convergence')+"'>" + _("Itérations forcées") + " :</dt><dd>" + parseInt(data["config"]["force_iterations"]) + '</dd>');
  $('<dl/>', {
    'class': 'inline-flex',
    html: items.join('')
  }).appendTo('#rapport');
}
function show_info_calc(){
  //Informations sur le calcul ------------------------------------------------------------------------------------
   $("<p/>").html('<a href="#info_calc">' + _('Informations sur le calcul') + '</a>').appendTo('#sommaire');
  $("<h2/>", {
    text: _('Informations sur le calcul'),
    id: 'info_calc'
  }).appendTo('#rapport');
  $("<a/>", {
    href: '#top'
  }).html('&#8593;').appendTo('#info_calc');
  items = ["<dt>" + _("Compensation effectuée") + " :</dt><dd>" + bool(data["computation"]["compensationDone"]) + '</dd>'];
  if ((data["config"]["compute_type"] == 0) && (data["computation"]["compensationDone"] || data["computation"]["asked_to_stop"])) {
    items.push("<dt>"+ _("&sigma;0 initial") +" :</dt><dd>" + parseFloat(data["computation"]["sigma_0_init"]).toFixed(num_decimales) + '</dd>');
    items.push("<dt>" + _("&sigma;0 final") + " :</dt><dd>" + parseFloat(data["computation"]["sigma_0_final"]).toFixed(num_decimales) + '</dd>');
  }
  items.push("<dt>" + _("Itérations") + " :</dt><dd>" + parseInt(data["computation"]["nbr_iterations"]) + '</dd>');
  items.push("<dt>" + _("Interruption du calcul") + " :</dt><dd>" + bool(data["computation"]["asked_to_stop"]) + '</dd>');
  if (data["computation"]["compensationDone"]){
     items.push("<dt>" + _("Début du calcul") + " :</dt><dd>" + data["computation"]["computation_start"].substring(0,20) + '</dd>');
     items.push("<dt>" + _("Durée du calcul") + " :</dt><dd>" + data["computation"]["computation_duration"].substring(3,5) + "'"+data["computation"]["computation_duration"].substring(6,13) +'"</dd>');
  }
  items.push("<dt>" + _("Rayon de la sphère") + " :</dt><dd>" + parseFloat(data["computation"]["projection"]["earth_model_radius"]).toFixed(2) + ' m</dd>');
  items.push("<dt>" + _("Nombre d'observations total") + "</dt><dd>" + parseInt(data["computation"]["nbr_all_obs"]) + '</dd>');
  items.push("<dt>" + _("Nombre d'observations actives") + "</dt><dd>" + parseInt(data["computation"]["nbr_active_obs"]) + '</dd>');
  items.push("<dt>" + _("Paramètres") + " :</dt><dd>" + parseInt(data["computation"]["nbr_parameters"]) + '</dd>');
  items.push("<dt>" + _("Inversion de la matrice normale") + " :</dt><dd>" + bool(data["computation"]["invertedMatrix"]) + '</dd>');
  items.push("<dt>" + _("Contraintes internes") + " :</dt><dd>" + bool(data["computation"]["internal_constraints"]) + '</dd>');
  $('<dl/>', {
    'class': 'inline-flex',
    html: items.join('')
  }).appendTo('#rapport');
  items=['<p><input type="button" id="messageReadC" onclick="displayMessagesReadConfig()" ></input></p> '];
  items.push('<div id="messages_read_config" style="display: block;" >'+ data["computation"]["messages_read_config"]+'</div>');
  items.push('<p><input type="button" id="messageRead" onclick="displayMessagesRead()"></input></p> ');
  items.push('<div id="messages_read_data" style="display: block;" >'+ data["computation"]["messages_read_data"]+'</div>');
  items.push('<p><input type="button" id="messageLeast" onclick="displayMessagesLeast_squares()"></input></p> ');
  items.push('<div id="messages_set_least_squares" style="display: block;" >'+ data["computation"]["messages_set_least_squares"]+'</div>');
  items.push('<p><input type="button" id="messageComputation" onclick="displayMessagesComputation()"></input></p> ');
  items.push('<div id="messages_computation" style="display: none;" >'+ data["computation"]["messages_computation"]+'</div>');
   $('<div/>', {
    html: items.join('')
  }).appendTo('#rapport');

  displayMessagesReadConfig();
  displayMessagesRead();
  displayMessagesLeast_squares();
  displayMessagesComputation();
}
function show_evol_sigma0(){
   //Graph sigma 0 ------------------------------------------------------------------------------------
  $("<p/>").html('<a href="#evol_sigma0">' + _('Évolution du &sigma;0') + '</a>').appendTo('#sommaire');
  var all_sigma0_labels = [];
  var chi2_max = [];
  var chi2_min = [];
  var all_sigma0_val = [];
  $.each(data["computation"]["all_sigma0"], function(index, value) {
    all_sigma0_labels.push(index);
    all_sigma0_val.push(value);
    chi2_max.push(data["computation"]["chi2_test"]["max"]);
    chi2_min.push(data["computation"]["chi2_test"]["min"]);
  });
  var sigma0_evol_chart_config = {
    type: 'line',
    data: {
      labels: all_sigma0_labels,
      datasets: [{
          label: "sigma0",
          backgroundColor: "rgba(255,162,0,0.5)",
          fill: false,
          borderColor: "rgba(255,162,0,1)",
          pointColor: "rgba(255,162,0,1)",
          pointStrokeColor: "#fff",
          data: all_sigma0_val,
          lineTension: 0.0
        },
        {
          label: "chi2 max",
          borderColor: "rgba(150,100,100,0.9)",
          pointRadius: 0,
          data: chi2_max,
          fill: false
        },
        {
          label: "chi2 min",
          borderColor: "rgba(100,150,100,0.9)",
          pointRadius: 0,
          data: chi2_min,
          fill: false
        }
      ]
    },
    options: {
      responsive: true,
      title: {
        display: false,
      },
      tooltips: {
        mode: 'index',
        intersect: false,
      },
      hover: {
        mode: 'nearest',
        intersect: true
      },
      scales: {
        xAxes: [{
          display: true,
          scaleLabel: {
            display: true,
            labelString: _('Iteration')
          }
        }],
        yAxes: [{
          display: true,
          scaleLabel: {
            display: true,
            labelString: 'Sigma0'
          },
          type: 'logarithmic',
          ticks: {
            min: 0,
            callback: function(value, index, values) {
              str = value.toExponential()
              if ((str[0] == "1") || (str[0] == "2") || (str[0] == "5"))
                return value.toString();
              else return "";
            },
          }
        }]
      }
    }
  };
  $("<h2/>", {
    html: _('Évolution du &sigma;0'),
    id: "evol_sigma0"
  }).appendTo('#rapport');
  $("<a/>", {
    href: '#top'
  }).html('&#8593;').appendTo('#evol_sigma0');
  $("<canvas id='sigma0_chart' width='800' height='400'></canvas>").appendTo('#rapport');
  var ctx = $("#sigma0_chart").get(0).getContext("2d");
  //This will get the first returned node in the jQuery collection.
  var myNewChart = new Chart(ctx, sigma0_evol_chart_config);
}
function show_chi2(){
  //Test du chi2 ------------------------------------------------------------------------------------
  $("<p/>").html('<a href="#test_chi2">' + _('Test du &#935;²') + '</a>').appendTo('#sommaire');
  var chi2OK = (parseFloat(data["computation"]["chi2_test"]["min"]) < parseFloat(data["computation"]["sigma_0_final"])) &&
    (parseFloat(data["computation"]["sigma_0_final"]) < parseFloat(data["computation"]["chi2_test"]["max"]));
  var emoticon = "?";
  if (!chi2OK) emoticon = "&#128547;";
  else emoticon = "&#128517;";
  if (parseFloat(data["computation"]["sigma_0_final"]) > 10)
    emoticon = "&#128561;";
  else if (parseFloat(data["computation"]["sigma_0_final"]) > 100)
    emoticon = "&#128552;";
  $("<h2/>", {
    html: _('Test du &#935;² : ') + emoticon,
    id: "test_chi2"
  }).appendTo('#rapport');
  $("<a/>", {
    href: '#top'
  }).html('&#8593;').appendTo('#test_chi2');
  $("<p>", {
    text: _('Confiance : ') + data["computation"]["chi2_test"]["confidence"] * 100 + "%"
  }).appendTo('#rapport');
  $("<p>", {
    text: _('Degrés de liberté : ') + data["computation"]["chi2_test"]["DOF"],
    title: _('Nombre d\'observations actives moins nombre de paramètres')
  }).appendTo('#rapport');
  $("<p>", {
    text: _('Test : ') + parseFloat(data["computation"]["chi2_test"]["min"]).toFixed(num_decimales) + " < " +
      parseFloat(data["computation"]["sigma_0_final"]).toFixed(num_decimales) + " < " +
      parseFloat(data["computation"]["chi2_test"]["max"]).toFixed(num_decimales) + " ?"
  }).appendTo('#rapport');
  //see http://character-code.com/emoticons-html-codes.php
  $("<p>", {
    html: _('Test réussi : ') + bool(chi2OK) + " !"
  }).appendTo('#rapport');
}
function show_coord_init(){
  //write init coords ------------------------------------------------------------------------------------
  $("<p/>").html('<a href="#coord_init">' + _('Coordonnées initiales') + '</a>').appendTo('#sommaire');
  $("<h2/>", {
    text: _('Coordonnées initiales'),
    id: 'coord_init'
  }).appendTo('#rapport');
  $("<a/>", {
    href: '#top'
  }).html('&#8593;').appendTo('#coord_init');
  items = ["<tr><th class=\"name\">" + _("Nom") +
    "</th><th>" + _("X init") +
    "</th><th>" + _("Y init") +
    "</th><th>" + _("Z init") +
    "</th><th>" + _("&sigma;X init") +
    "</th><th>" + _("&sigma;Y init") +
    "</th><th>" + _("&sigma;Z init") +
    "</th><th title='"+_('Nombre d&apos;observations actives en lien avec le point')+"'>" + _("Obs actives") + "</th></tr>"
  ];
  for (var i = 0; i < all_pts.length; i++) {
    var pt = all_pts[i];
    items.push('<tr class=\"' + parite[i % 2] + '\"><td class=\"name\">' + pt.name + 
    '</td><td>' + parseFloat(pt.coord_read[0]).toFixed(num_decimales) +
    '</td><td>' + parseFloat(pt.coord_read[1]).toFixed(num_decimales) + 
    '</td><td>' + parseFloat(pt.coord_read[2]).toFixed(num_decimales) + '</td>');

    items.push(point_sigmas(pt));

    items.push('<td>' + pt.nbActiveObs + '</td>');
    items.push('</tr>');
  }
  $('<table/>', {
    'class': 'points',
    html: items.join('')
  }).appendTo('#rapport')
}
function show_obs(){
  //write observations ------------------------------------------------------------------------------------
  $("<p/>").html('<a href="#obs">' + _('Observations') + '</a>').appendTo('#sommaire');
  $("<h2/>", {
    text: 'Observations',
    id: 'obs'
  }).appendTo('#rapport');
  $("<a/>", {
    href: '#top'
  }).html('&#8593;').appendTo('#obs');
    items = ["<table id='observations_table''> <thead><tr>" +
      "<th title='"+_('Type d&apos;observation') +"' class=\"name\">" + _("Code") +
      "</th><th title='"+_("Provenance de la mesure") +"' class=\"name\">" + _("De") +
      "</th><th title='"+_("Point visé") +"' class=\"name\">" + _("Vers") +
      "</th><th title='"+_('Observation')+"'>" + _("Mesure") +
      "</th><th title='"+_('Distance entre les coordonnées compensées des 2 points')+"'>" + _("Distance") +
      "</th><th title='"+_("Sigma absolu + sigma relatif")+"'>" +_("&sigma; total") +
      "</th><th class='redondance' title='"+_("Sigma sur l&apos;observation obtenue après compensation")+"'>"+ _("&sigma; a posteriori") +
      "</th><th title='"+_('Écart entre l&apos;observation compensée et l&apos;observation mesurée') + "'>" + _("Résidu") +
      "</th><th title='"+_('Résidu divisé par le sigma total')+"' >" + _("Résidu normalisé") +
      "</th><th class='redondance' title='"+_("0% : observation indispensable / 100% : observation inutile")+"'>" + _("Redondance") +
      "</th></tr></thead>"
    ];
    var last_file = -1;
    for (var i = 0; i < all_obs.length; i++) {
      var obs = all_obs[i];

      str_active_class = '';
      str_etoile = ''
      if (!obs.active) {
        str_active_class = ' inactive';
        str_etoile = '* ';
      } else {
        all_active_obs.push(obs);
        if ((all_obs[i].code === 5) || (all_obs[i].code === 7) || (all_obs[i].code === 8))
          exist_hz = true;
        else if (all_obs[i].code === 6)
          exist_zen = true;
        else if ((all_obs[i].code === 1) || (all_obs[i].code === 3))
          exist_dist = true;
        else if ((all_obs[i].code >= 101) && (all_obs[i].code <= 106))
          exist_basc = true;
        else if ((all_obs[i].code === -1) || (all_obs[i].code === -2) || (all_obs[i].code === -3))
          exist_coord = true;
        else if (all_obs[i].code === 4)
          exist_den = true;
      }
      str_res_mm = '';
      if (obs.unit_str === 'm')
        str_res_mm = obs.residual * 1000;
      else
        str_res_mm = obs.residual * obs.obs_length * obs.unit_factor * 1000;

      if (obs.file !== last_file) {
        last_file = obs.file;
        items.push(' <tr class="filename"><td colspan="10"> <a href="' + all_files[obs.file] + '" download>' + all_files[obs.file] + '</a></td></tr>');
      }
      if (obs.active) {
      items.push('<tr  class=\"' + parite[i % 2] + str_active_class + '\" id="' + all_files[obs.file] + ':' + obs.line + '" title="' + all_files[obs.file] + ':' + obs.line +
        '"><td class=\"name\">' + str_etoile + codes_obs[obs.code] +
        '</td><td class=\"name\">' + obs.from +
        '</td><td class=\"name\">' + obs.to +
        '</td><td>' + parseFloat(obs.original_value).toFixed(num_decimales) + ' ' + obs.unit_str +
        '</td><td>' + parseFloat(obs.obs_length).toFixed(num_decimales) + ' m' +
        '</td><td>' + parseFloat(obs.sigma_total).toFixed(num_decimales) + ' ' + obs.unit_str +
        '</td><td class="redondance">' + parseFloat(obs.sigma_a_posteriori).toFixed(num_decimales) + ' ' + obs.unit_str +
        '</td><td>' + str_res_mm.toFixed(num_decimales_mini) + ' mm' +
        '</td><td>' + parseFloat(obs.normalized_residual).toFixed(num_decimales_mini) + ' 𝜎' +
        '</td><td class="redondance">' + Math.abs(parseFloat(obs.obsRedondancy)).toFixed(num_decimales_mini-1) + ' %</td></tr>');
      } else {
        items.push('<tr  class=\"' + parite[i % 2] + str_active_class + '\" id="' + all_files[obs.file] + ':' + obs.line + '" title="' + all_files[obs.file] + ':' + obs.line +
        '"><td class=\"name\">' + str_etoile + codes_obs[obs.code] +
        '</td><td class=\"name\">' + obs.from +
        '</td><td class=\"name\">' + obs.to +
        '</td><td>' + parseFloat(obs.original_value).toFixed(num_decimales) + ' ' + obs.unit_str +
        '</td><td>' + parseFloat(obs.obs_length).toFixed(num_decimales) + ' m' +
        '</td><td>' + parseFloat(obs.sigma_total).toFixed(num_decimales) + ' ' + obs.unit_str +
        '</td><td class="redondance">-' +
        '</td><td>' + str_res_mm.toFixed(num_decimales_mini) + ' mm' +
        '</td><td>' + parseFloat(obs.normalized_residual).toFixed(num_decimales_mini) + ' 𝜎' +
        '</td><td class="redondance">-</td></tr>');
      }
    }
  $('<table/>', {
    'class': 'points',
    html: items.join('')
  }).appendTo('#rapport');
  if (!data["computation"]["invertedMatrix"]) {
    $('.redondance').remove();
  }
}
function show_repart_residuals(){
  //Charts ------------------------------------------------------------------------------------
  $("<p/>").html('<a href="#repart_residuals">' + _('Répartition des résidus') + '</a>').appendTo('#sommaire');
  //prepare residuals histogram -----------------------
  var residuals_class_width = 0.5;
  var all_residuals_class_labels=["<-3𝜎"];
  var all_residuals_class_val=[0];
  var all_residuals_class_val_hz=[0];
  var all_residuals_class_val_zen=[0];
  var all_residuals_class_val_dist=[0];
  var all_residuals_class_val_den=[0];
  var all_residuals_class_val_bascule=[0];
  var all_residuals_class_val_coord=[0];
  var all_residuals_class_val_std=[0];
  for (var i = 0; i < 6 / residuals_class_width - 1; i++) {
    var x = -3 + (i + 1) * residuals_class_width;
    all_residuals_class_labels.push(x.toFixed(1) + "𝜎");
    all_residuals_class_val.push(0);
    all_residuals_class_val_hz.push(0);
    all_residuals_class_val_zen.push(0);
    all_residuals_class_val_dist.push(0);
    all_residuals_class_val_den.push(0);
    all_residuals_class_val_bascule.push(0);
    all_residuals_class_val_coord.push(0);
    //standard: 1/sqrt(2*pi)*e^(-x**2/2)
    all_residuals_class_val_std.push(all_active_obs.length / Math.sqrt(2 * Math.PI) * Math.exp(-(x * x / 1)) * residuals_class_width);
  }
  all_residuals_class_labels.push(">3𝜎");
  all_residuals_class_val.push(0);
  all_residuals_class_val_hz.push(0);
  all_residuals_class_val_zen.push(0);
  all_residuals_class_val_dist.push(0);
  all_residuals_class_val_den.push(0);
  all_residuals_class_val_bascule.push(0);
  all_residuals_class_val_coord.push(0);
  all_residuals_class_val_std.push(0);

  for (var i = 0; i < all_active_obs.length; i++) {
    var class_num = Math.round((all_active_obs[i].normalized_residual + 3) / residuals_class_width);
    class_num = Math.min(class_num, all_residuals_class_labels.length - 1);
    class_num = Math.max(class_num, 0);
    all_residuals_class_val[class_num] += 1;
    if ((all_active_obs[i].code === 5) || (all_active_obs[i].code === 7) || (all_active_obs[i].code === 8))
      all_residuals_class_val_hz[class_num] += 1;
    else if (all_active_obs[i].code === 6)
      all_residuals_class_val_zen[class_num] += 1;
    else if ((all_active_obs[i].code === 1) || (all_active_obs[i].code === 3))
      all_residuals_class_val_dist[class_num] += 1;
    else if ((all_active_obs[i].code >= 101) && (all_active_obs[i].code <= 106))
      all_residuals_class_val_bascule[class_num] += 1;
    else if ((all_active_obs[i].code === -1) || (all_active_obs[i].code === -2) || (all_active_obs[i].code === -3))
      all_residuals_class_val_coord[class_num] += 1;
    else if (all_active_obs[i].code === 4)
      all_residuals_class_val_den[class_num] += 1;
  }

  var all_residuals_class_config = {
    type: 'bar',
    data: {
      labels: all_residuals_class_labels,
      datasets: [{
          label: _("Standard"),
          fill: false,
          backgroundColor: "rgba(120,120,120,1)",
          borderColor: "rgba(120,120,120,1)",
          pointRadius: 0,
          data: all_residuals_class_val_std,
          type: 'line'
        },
        {
          label: _("Tous les résidus"),
          backgroundColor: "rgba(255,162,0,1)",
          borderColor: "rgba(255,162,0,1)",
          pointRadius: 0,
          data: all_residuals_class_val,
        },
      ]
    },
    options: {
      responsive: true,
      title: {
        display: true,
        text: _("Répartition des résidus normalisés")
      },
      showTooltips: false,
      hover: {
        mode: 'nearest',
        intersect: true
      },
      scales: {
        xAxes: [{
          display: true,
          scaleLabel: {
            display: false,
          }
        }],
        yAxes: [{
          display: true,
          scaleLabel: {
            display: false,
          }
        }]
      }
    }
  };

  //prepare datas for residuals vs distance charts -----------------------
  var min_dist = 10000;
  var max_dist = 0;
  for (var i = 0; i < all_active_obs.length; i++) {
    if ((all_active_obs[i].code === 1) || (all_active_obs[i].code === 3) ||
      (all_active_obs[i].code === 5) || (all_active_obs[i].code === 6) ||
      (all_active_obs[i].code === 7) || (all_active_obs[i].code === 8) ||
      ((all_active_obs[i].code >= 101) && (all_active_obs[i].code <= 106))) {
      if (all_active_obs[i].obs_length > max_dist)
        max_dist = all_active_obs[i].obs_length;
      if ((all_active_obs[i].obs_length > 0.1) && (all_active_obs[i].obs_length < min_dist))
        min_dist = all_active_obs[i].obs_length;
    }
  }
  min_dist-=0.001;
  max_dist+=0.001;
  var dist_chart_num_steps = 10;
  var dist_chart_start_step = min_dist;
  var dist_chart_factor_step = Math.pow((max_dist / dist_chart_start_step), 1 / (dist_chart_num_steps - 1));
  var all_dists = [];
  var dist_residuals_class_labels = [];
  var dist_residuals_class_val_std = [];
  var dist_residuals_class_val_hz = [];
  var dist_residuals_class_val_hz_abs = [];
  var dist_residuals_class_val_hz_num = [];
  var dist_residuals_class_val_hz_et = []; //ecart type
  var dist_residuals_class_val_zen = [];
  var dist_residuals_class_val_zen_abs = [];
  var dist_residuals_class_val_zen_num = [];
  var dist_residuals_class_val_zen_et = [];
  var dist_residuals_class_val_dist_abs = [];
  var dist_residuals_class_val_dist = [];
  var dist_residuals_class_val_dist_num = [];
  var dist_residuals_class_val_dist_et = [];
  var dist_residuals_class_val_basc = [];
  var dist_residuals_class_val_basc_abs = [];
  var dist_residuals_class_val_basc_num = [];
  var dist_residuals_class_val_basc_et = [];
  var dist_residuals_all = [];
  var dist = dist_chart_start_step;
  for (var i = 0; i < dist_chart_num_steps + 1; i++) {
    all_dists.push(dist);
    dist_residuals_class_labels.push("<" + dist.toFixed(1) + "m");
    dist_residuals_class_val_std.push(1.0);
    dist_residuals_class_val_hz.push(0);
    dist_residuals_class_val_hz_abs.push(0);
    dist_residuals_class_val_hz_num.push(0);
    dist_residuals_class_val_hz_et.push(0);
    dist_residuals_class_val_zen.push(0);
    dist_residuals_class_val_zen_abs.push(0);
    dist_residuals_class_val_zen_num.push(0);
    dist_residuals_class_val_zen_et.push(0);
    dist_residuals_class_val_dist.push(0);
    dist_residuals_class_val_dist_abs.push(0);
    dist_residuals_class_val_dist_num.push(0);
    dist_residuals_class_val_dist_et.push(0);
    dist_residuals_class_val_basc.push(0);
    dist_residuals_class_val_basc_abs.push(0);
    dist_residuals_class_val_basc_num.push(0);
    dist_residuals_class_val_basc_et.push(0);
    dist *= dist_chart_factor_step;
  }
  for (var i = 0; i < all_active_obs.length; i++) {
    var class_num = 0;
    for (var j = 0; j < dist_chart_num_steps - 1; j++) {
      if (all_active_obs[i].obs_length > all_dists[j])
        class_num++;
    }
    if ((all_active_obs[i].code === 5) || (all_active_obs[i].code === 7) || (all_active_obs[i].code === 8)) {
      dist_residuals_class_val_hz_num[class_num] += 1;
      dist_residuals_class_val_hz[class_num] += (all_active_obs[i].normalized_residual);
      dist_residuals_class_val_hz_abs[class_num] += Math.abs(all_active_obs[i].normalized_residual);
    }
    if (all_active_obs[i].code === 6) {
      dist_residuals_class_val_zen_num[class_num] += 1;
      dist_residuals_class_val_zen[class_num] += (all_active_obs[i].normalized_residual);
      dist_residuals_class_val_zen_abs[class_num] += Math.abs(all_active_obs[i].normalized_residual);
    }
    if ((all_active_obs[i].code === 1) || (all_active_obs[i].code === 3)) {
      dist_residuals_class_val_dist_num[class_num] += 1;
      dist_residuals_class_val_dist[class_num] += (all_active_obs[i].normalized_residual);
      dist_residuals_class_val_dist_abs[class_num] += Math.abs(all_active_obs[i].normalized_residual);
    }
    if ((all_active_obs[i].code >= 101) && (all_active_obs[i].code <= 106)) {
      dist_residuals_class_val_basc_num[class_num] += 1;
      dist_residuals_class_val_basc[class_num] += (all_active_obs[i].normalized_residual);
      dist_residuals_class_val_basc_abs[class_num] += Math.abs(all_active_obs[i].normalized_residual);
    }
  }
  for (var i = 0; i < dist_chart_num_steps; i++) {
    if (dist_residuals_class_val_hz_num[i] > 0)
    {
      dist_residuals_class_val_hz[i] /= dist_residuals_class_val_hz_num[i];
      dist_residuals_class_val_hz_abs[i] /= dist_residuals_class_val_hz_num[i];
    }
    //else dist_residuals_class_val_hz[i]=parseFloat("NaN");
    if (dist_residuals_class_val_zen_num[i] > 0)
    {
      dist_residuals_class_val_zen[i] /= dist_residuals_class_val_zen_num[i];
      dist_residuals_class_val_zen_abs[i] /= dist_residuals_class_val_zen_num[i];
    }
    //else dist_residuals_class_val_zen[i]=parseFloat("NaN");
    if (dist_residuals_class_val_dist_num[i] > 0)
    {
      dist_residuals_class_val_dist[i] /= dist_residuals_class_val_dist_num[i];
      dist_residuals_class_val_dist_abs[i] /= dist_residuals_class_val_dist_num[i];
    }
    if (dist_residuals_class_val_basc_num[i] > 0)
    {
      dist_residuals_class_val_basc[i] /= dist_residuals_class_val_basc_num[i];
      dist_residuals_class_val_basc_abs[i] /= dist_residuals_class_val_basc_num[i];
    }
    //else dist_residuals_class_val_dist[i]=parseFloat("NaN");
  }
  for (var i = 0; i < all_active_obs.length; i++) {
    var class_num = 0;
    for (var j = 0; j < dist_chart_num_steps - 1; j++) {
      if (all_active_obs[i].obs_length > all_dists[j])
        class_num++;
    }
    if ((all_active_obs[i].code === 5) || (all_active_obs[i].code === 7) || (all_active_obs[i].code === 8)) {
      dist_residuals_class_val_hz_et[class_num] += Math.abs(all_active_obs[i].normalized_residual - dist_residuals_class_val_hz[class_num]);
    }
    if (all_active_obs[i].code === 6) {
      dist_residuals_class_val_zen_et[class_num] += Math.abs(all_active_obs[i].normalized_residual - dist_residuals_class_val_zen[class_num]);
    }
    if ((all_active_obs[i].code === 1) || (all_active_obs[i].code === 3)) {
      dist_residuals_class_val_dist_et[class_num] += Math.abs(all_active_obs[i].normalized_residual - dist_residuals_class_val_dist[class_num]);
    }
    if ((all_active_obs[i].code >= 101) && (all_active_obs[i].code <= 106)) {
      dist_residuals_class_val_basc_et[class_num] += Math.abs(all_active_obs[i].normalized_residual - dist_residuals_class_val_basc[class_num]);
    }
  }
  for (var i = 0; i < dist_chart_num_steps; i++) {
    if (dist_residuals_class_val_hz_num[i] > 0)
      dist_residuals_class_val_hz_et[i] /= dist_residuals_class_val_hz_num[i];
    if (dist_residuals_class_val_zen_num[i] > 0)
      dist_residuals_class_val_zen_et[i] /= dist_residuals_class_val_zen_num[i];
    if (dist_residuals_class_val_dist_num[i] > 0)
      dist_residuals_class_val_dist_et[i] /= dist_residuals_class_val_dist_num[i];
    if (dist_residuals_class_val_basc_num[i] > 0)
      dist_residuals_class_val_basc_et[i] /= dist_residuals_class_val_basc_num[i];
  }
  //~ //Fill of the tables (if obs type exists) to draw graphes type-based normalized residual repartition and distance normalized residual repartition
  var data2graph_type = []
  var data2graph_dist = []
  if (exist_hz) {
    data2graph_type.push({
      label: _("Horizontales"),
      backgroundColor: "rgba(0,180,180,1)",
      borderColor: "rgba(100,180,180,1)",
      pointRadius: 0,
      data: all_residuals_class_val_hz,
    });
    data2graph_dist.push({
      label: _("Horizontales"),
      backgroundColor: "rgba(0,180,180,1)",
      borderColor: "rgba(100,180,180,1)",
      pointRadius: 0,
      data: dist_residuals_class_val_hz_abs,
    })
    dist_residuals_all.push([dist_residuals_class_val_hz, dist_residuals_class_val_hz_num, dist_residuals_class_val_hz_et, dist_residuals_class_val_hz_abs]);
  }
  if (exist_zen) {
    data2graph_type.push({
      label: _("Zénithales"),
      backgroundColor: "rgba(0,220,0,1)",
      borderColor: "rgba(100,220,100,1)",
      pointRadius: 0,
      data: all_residuals_class_val_zen,
    });
    data2graph_dist.push({
      label: _("Zénithales"),
      backgroundColor: "rgba(0,220,0,1)",
      borderColor: "rgba(100,220,100,1)",
      pointRadius: 0,
      data: dist_residuals_class_val_zen_abs,
    })
    dist_residuals_all.push([dist_residuals_class_val_zen, dist_residuals_class_val_zen_num, dist_residuals_class_val_zen_et, dist_residuals_class_val_zen_abs]);
  }
  if (exist_dist) {
    data2graph_type.push({
      label: _("Distances"),
      backgroundColor: "rgba(0,0,220,1)",
      borderColor: "rgba(100,100,220,1)",
      pointRadius: 0,
      data: all_residuals_class_val_dist,
    });
    data2graph_dist.push({
      label: _("Distances"),
      backgroundColor: "rgba(0,0,220,1)",
      borderColor: "rgba(100,100,220,1)",
      pointRadius: 0,
      data: dist_residuals_class_val_dist_abs,
    })
    dist_residuals_all.push([dist_residuals_class_val_dist, dist_residuals_class_val_dist_num, dist_residuals_class_val_dist_et, dist_residuals_class_val_dist_abs]);
  }
  if (exist_basc) {
    data2graph_type.push({
      label: _("Bascules"),
      backgroundColor: "rgba(200,0,200,1)",
      borderColor: "rgba(200,100,200,1)",
      pointRadius: 0,
      data: all_residuals_class_val_bascule,
    });
    data2graph_dist.push({
      label: _("Bascules"),
      backgroundColor: "rgba(200,0,200,1)",
      borderColor: "rgba(200,100,220,1)",
      pointRadius: 0,
      data: dist_residuals_class_val_basc_abs,
    })
    dist_residuals_all.push([dist_residuals_class_val_basc, dist_residuals_class_val_basc_num, dist_residuals_class_val_basc_et, dist_residuals_class_val_basc_abs]);
  }
  if (exist_coord) {
    data2graph_type.push({
      label: _("Coord"),
      backgroundColor: "rgba(200,200,0,1)",
      borderColor: "rgba(200,200,100,1)",
      pointRadius: 0,
      data: all_residuals_class_val_coord,
    })
  }
  if (exist_den) {
    data2graph_type.push({
      label: _("Dénivelés"),
      backgroundColor: "rgba(255,215,0,1)",
      borderColor: "rgba(255,215,0,1)",
      pointRadius: 0,
      data: all_residuals_class_val_den,
    })
  }

  //prepare type-based normalized residual repartition charts -----------------------
  var all_residuals_class_config_type = {
    type: 'bar',
    data: {
      labels: all_residuals_class_labels,
      datasets: data2graph_type
    },
    options: {
      responsive: true,
      title: {
        display: true,
        text: _("Répartition des résidus normalisés par type")
      },
      showTooltips: false,
      hover: {
        mode: 'nearest',
        intersect: true
      },
      scales: {
        xAxes: [{
          display: true,
          scaleLabel: {
            display: false,
          }
        }],
        yAxes: [{
          display: true,
          scaleLabel: {
            display: false,
          }
        }]
      }
    }
  };

  //prepare residuals vs distance charts -----------------------
  var dist_residuals_class_config_type = {
    type: 'bar',
    data: {
      labels: dist_residuals_class_labels,
      datasets: data2graph_dist
    },
    options: {
      responsive: true,
      title: {
        display: true,
        text: _("Résidus absolus moyens par rapport à la distance")
      },
      showTooltips: true,
      tooltips: {
        callbacks: {
          label: function(tooltipItem, data) {
            return " Abs : " + dist_residuals_all[tooltipItem.datasetIndex][3][tooltipItem.index].toFixed(2) + "𝜎  | NoAbs : " +
              dist_residuals_all[tooltipItem.datasetIndex][0][tooltipItem.index].toFixed(2) + "𝜎 +/-" +
              dist_residuals_all[tooltipItem.datasetIndex][2][tooltipItem.index].toFixed(2) +
              "𝜎 | NbObs: " + dist_residuals_all[tooltipItem.datasetIndex][1][tooltipItem.index];
            //return tooltipItem.index+" "+tooltipItem.datasetIndex;//Object.keys(tooltipItem);
            //return data.datasets[0].data[0];//Object.keys(data);
          }
        }
      },
      hover: {
        mode: 'nearest',
        intersect: true
      },
      scales: {
        xAxes: [{
          display: true,
          scaleLabel: {
            display: false,
          }
        }],
        yAxes: [{
          display: true,
          scaleLabel: {
            display: false,
          },
          ticks: {
            callback: function(value, index, values) {
              return value.toFixed(2) + "𝜎";
            },
          }
        }]
      }
    }
  };
  //write charts ------------------------------------------------------------------------------------
  $("<h2/>", {
    text: _('Répartition des résidus'),
    id: 'repart_residuals'
  }).appendTo('#rapport');
  $("<a/>", {
    href: '#top'
  }).html('&#8593;').appendTo('#repart_residuals');
  $("<table id='residuals_charts'/>").html("<tr><td><canvas id='residuals_chart' width='400' height='300'/></td>" +
    "<td><canvas id='residuals_chart_type' width='400' height='300'/></td></tr>").appendTo('#rapport');
  var ctx2 = $("#residuals_chart").get(0).getContext("2d");
  var myNewChart2 = new Chart(ctx2, all_residuals_class_config);
  var ctx3 = $("#residuals_chart_type").get(0).getContext("2d");
  var myNewChart3 = new Chart(ctx3, all_residuals_class_config_type);
  $("<table id='dist_residuals_charts_type'/>").html("<tr><td><canvas id='dist_residuals_chart_type' width='800' height='300'/></td></tr>").appendTo('#rapport');
  var ctx4 = $("#dist_residuals_chart_type").get(0).getContext("2d");
  var myNewChart4 = new Chart(ctx4, dist_residuals_class_config_type);
}
function show_biggest_residuals(){
  $("<p/>").html('<a href="#biggest_residuals">' + _('Plus gros résidus') + '</a>').appendTo('#sommaire');
  //write biggest residuals ------------------------------------------------------------------------------------
  $("<h2/>", {
    text: _('Plus gros résidus'),
    id: 'biggest_residuals',
    title: _('les 20 plus gros résidus normalisés du plus grand au plus petit')
  }).appendTo('#rapport');
  $("<a/>", {
    href: '#top'
  }).html('&#8593;').appendTo('#biggest_residuals');
  items = ["<thead><tr><th width=3%>" +
    "<th title='"+_('Type d&apos;observation') +"' class=\"name\">" + _("Code") +
    "</th><th title='"+_("Provenance de la mesure") +"' class=\"name\">" + _("De") +
    "</th><th title='"+_("Point visé") +"' class=\"name\">" + _("Vers") +
    "</th><th title='"+_('Observation')+"'>" + _("Mesure") +
    "</th><th title='"+_('Distance entre les coordonnées compensées des 2 points')+"'>" + _("Distance") +
    "</th><th title='"+_("Sigma absolu + sigma relatif")+"'>" +_("&sigma; total") +
    "</th><th class='redondance' title='"+_("Sigma sur l&apos;observation obtenue après compensation")+"'>"+ _("&sigma; a posteriori") +
    "</th><th title='"+_('Écart entre l&apos;observation compensée et l&apos;observation mesurée') + "'>" + _("Résidu") +
    "</th><th title='"+_('Résidu divisé par le sigma total')+"' >" + _("Résidu normalisé") +
    "</th><th class='redondance' title='"+_("0% : observation indispensable / 100% : observation inutile")+"'>" + _("Redondance") +
    "</th></tr></thead>"
  ];
  all_active_obs.sort(residualSortFunction);
  for (var i = 0; i < Math.min(max_biggest_residuals, all_active_obs.length); i++) {
    str_res_mm = '';
    if (all_active_obs[i].unit_str === 'm')
      str_res_mm = all_active_obs[i].residual * 1000;
    else
      str_res_mm = all_active_obs[i].residual * all_active_obs[i].obs_length * all_active_obs[i].unit_factor * 1000;
    items.push('<tr class=\"' + parite[i % 2] + '\" title="' + all_files[all_active_obs[i].file] + ':' + all_active_obs[i].line +
      '"><td><a href="#' + all_files[all_active_obs[i].file] + ':' + all_active_obs[i].line + '">↑</a>  </td><td class=\"name\">' + codes_obs[all_active_obs[i].code] +
      '</td><td class=\"name\">' + all_active_obs[i].from +
      '</td><td class=\"name\">' + all_active_obs[i].to + '</td><td>' +
      parseFloat(all_active_obs[i].original_value).toFixed(num_decimales) + ' ' + all_active_obs[i].unit_str +
      '</td><td>' + parseFloat(all_active_obs[i].obs_length).toFixed(num_decimales) + ' m' +
      '</td><td>' + parseFloat(all_active_obs[i].sigma_total).toFixed(num_decimales) + ' ' + all_active_obs[i].unit_str +
      '</td><td class="redondance">' + parseFloat(all_active_obs[i].sigma_a_posteriori).toFixed(num_decimales) + ' ' + all_active_obs[i].unit_str +
      '</td><td>' + str_res_mm.toFixed(num_decimales_mini) + ' mm ' +
      '</td><td style="color:Maroon;">' + parseFloat(all_active_obs[i].normalized_residual).toFixed(num_decimales_mini) + ' 𝜎'+
      '</td><td class="redondance">' + Math.abs(parseFloat(all_active_obs[i].obsRedondancy)).toFixed(num_decimales_mini-1) + ' %</td></tr>'
    );
  }
  $('<table/>', {
    'class': 'points',
    html: items.join('')
  }).appendTo('#rapport');
  if (!data["computation"]["invertedMatrix"]) {
    $('.redondance').remove();
  }
}
function show_bascules(){
  $("<p/>").html('<a href="#basc">' + _('Bascules') + '</a>').appendTo('#sommaire');
  $("<h2/>", {
    text: _('Bascules'),
    id: 'basc'
  }).appendTo('#rapport');
  $("<a/>", {
    href: '#top'
  }).html('&#8593;').appendTo('#basc');
  var triplet_types = {
    11: "cart obs",
    12: "angl obs"
  };
  items = ["<tr><th class=\"name\">" + _("Nom fichier") +
  "</th><th>" + _("Point origine") +
  "</th><th>" + _("Verticale") +
  "</th><th></th> <th colspan=\"3\">" + _("Coordonnées cartésiennes globales") + " (m)</th></tr>"];
  for (var i = 0; i < all_basc.length; i++) {
    var basc = all_basc[i];
    var origin = all_basc[i].origin;
    var pos = origin["coord_compensated_cartesian"];
    var matrix = basc["params"]["R_global2local"];
    var obs_type = triplet_types[basc["triplet_type"]];
    items.push('<tr class=\"' + parite[i % 2] + '\"><td class=\"name\" rowspan=\"2\">' + all_files[basc["observations"][0].file] + 
               '</td><td class=\"name\" rowspan=\"4\">' + basc.name + '</td>');
    items.push('<td rowspan=\"2\" >' + bool(basc.vertical) + '</td>');
    items.push('<td  class=\"name\"> Vect </td><td>' + parseFloat(pos[0]).toFixed(num_decimales) + 
               '</td><td>' + parseFloat(pos[1]).toFixed(num_decimales) + 
               '</td><td>' + parseFloat(pos[2]).toFixed(num_decimales) + '</td>');
    items.push('</tr>');
    items.push('<tr class=\"' + parite[i % 2] + '\"><td rowspan=\"3\"  class=\"name\"> Mat </td>');
    items.push('<td>' + parseFloat(matrix[0]).toFixed(num_decimales) + 
               '</td><td>' + parseFloat(matrix[1]).toFixed(num_decimales) + 
               '</td><td>' + parseFloat(matrix[2]).toFixed(num_decimales) + '</td></tr>');
    items.push('<tr class=\"' + parite[i % 2] + '\"><td rowspan=\"2\">' + obs_type + 
               '</td><td>' + _("Erreur") + 
               '</td><td>' + parseFloat(matrix[3]).toFixed(num_decimales) + 
               '</td><td>' + parseFloat(matrix[4]).toFixed(num_decimales) + 
               '</td><td>' + parseFloat(matrix[5]).toFixed(num_decimales) + '</td></tr>');
    items.push('<tr class=\"' + parite[i % 2] + '\"><td>' + parseFloat(basc.ang_to_vert).toFixed(num_decimales) + data["config"]["unit_name"] + '</td><td>' + parseFloat(matrix[6]).toFixed(num_decimales) + '</td><td>' + parseFloat(matrix[7]).toFixed(num_decimales) + '</td><td>' + parseFloat(matrix[8]).toFixed(num_decimales) + '</td></tr>');
  }
  $('<table/>', {
    'class': 'points',
    html: items.join('')
  }).appendTo('#rapport');
}
function show_coord_comp(){
  $("<p/>").html('<a href="#coord_comp">' + _('Coordonnées compensées') + '</a>').appendTo('#sommaire');
  $("<h2/>", {
    text: _('Coordonnées compensées'),
    id: 'coord_comp'
  }).appendTo('#rapport');
  $("<a/>", {
    href: '#top'
  }).html('&#8593;').appendTo('#coord_comp');
  items = ["<tr><th class=\"name\">" + _("Nom") +
    "</th><th>" + _("X comp") +
    "</th><th>" + _("Y comp") +
    "</th><th>" + _("Z comp") +
    "</th><th>" + _("&Delta;X") +
    "</th><th>" + _("&Delta;Y") +
    "</th><th>" + _("&Delta;Z") +
    "</th><th>" + _("&sigma;X init") +
    "</th><th>" + _("&sigma;Y init") +
    "</th><th>" + _("&sigma;Z init") +
    "</th><th title='"+_('Nombre d&apos;observations actives en lien avec le point')+"'>" + _("Obs actives") +
    "</th></tr>"
  ];
  for (var i = 0; i < all_pts.length; i++) {
    var pt = all_pts[i];
    items.push('<tr class=\"' + parite[i % 2] + '\" ><td class=\"name\">' + pt.name + '</td><td>' + parseFloat(pt.coord_compensated_stereographic[0]).toFixed(num_decimales) +
      '</td><td>' + parseFloat(pt.coord_compensated_stereographic[1]).toFixed(num_decimales) + '</td><td>' +
      parseFloat(pt.coord_compensated_stereographic[2]).toFixed(num_decimales) + '</td>');
    items.push('<td>' + (parseFloat(pt.coord_compensated_stereographic[0]) - parseFloat(pt.coord_read[0])).toFixed(num_decimales) +
      '</td><td>' + (parseFloat(pt.coord_compensated_stereographic[1]) - parseFloat(pt.coord_read[1])).toFixed(num_decimales) + '</td><td>' +
      (parseFloat(pt.coord_compensated_stereographic[2]) - parseFloat(pt.coord_read[2])).toFixed(num_decimales) + '</td>');

    items.push(point_sigmas(pt));

    items.push('<td>' + pt.nbActiveObs + '</td>');
    items.push('</tr>');
  }
  $('<table/>', {
    'class': 'points',
    html: items.join('')
  }).appendTo('#rapport');
}
function show_ellips(){
  $("<p/>").html('<a href="#ellips">' + _('Ellipsoïdes de confiance') + '</a>').appendTo('#sommaire');
  var sigma0_final = data["computation"]["sigma_0_final"];
  $("<h2/>", {
    text: _('Ellipsoïdes de confiance'),
    id: 'ellips'
  }).appendTo('#rapport');
  $("<a/>", {
    href: '#top'
  }).html('&#8593;').appendTo('#ellips');
  items = ["<tr><th class=\"name\">" + _("Nom") +
  "</th><th>" + _("1/2 Axe (mm)") +
  "</th><th>" + _("Azimut (gr)") +
  "</th><th>" + _("Site (gr)") + "</th></tr>"];
  for (var i = 0; i < all_pts.length; i++) {
    var pt = all_pts[i];
    if (pt.code === 4 || pt.code === 5)
    //Points 1D == Z
    {
      items.push('<tr class=\"' + parite[i % 2] + '\" ><td class=\"name\" >' + pt.name + '</td><td>' +
        parseFloat(pt.ellips.axes[0][0] * 1000).toFixed(num_decimales_mini + 1) + '</td><td>-</td><td>' +
        parseFloat(pt.ellips.axes[0][2]).toFixed(num_decimales_mini - 1) + '</td></tr>');
    } else {
      items.push('<tr class=\"' + parite[i % 2] + '\" ><td class=\"name\"  rowspan="3">' + pt.name + '</td>');
      items.push('<td>' +
        parseFloat(pt.ellips.axes[0][0] * 1000).toFixed(num_decimales_mini) + '</td><td>' +
        parseFloat(pt.ellips.axes[0][1]).toFixed(num_decimales) + '</td><td>' +
        parseFloat(pt.ellips.axes[0][2]).toFixed(num_decimales) + '</td>');
      items.push('</tr>');
      items.push('<tr class=\"' + parite[i % 2] + '\" >');
      items.push('<td>' +
        parseFloat(pt.ellips.axes[1][0] * 1000).toFixed(num_decimales_mini) + '</td><td>' +
        parseFloat(pt.ellips.axes[1][1]).toFixed(num_decimales) + '</td><td>' +
        parseFloat(pt.ellips.axes[1][2]).toFixed(num_decimales) + '</td>');
      items.push('</tr>');
      items.push('<tr class=\"' + parite[i % 2] + '\" >');
      items.push('<td>' +
        parseFloat(pt.ellips.axes[2][0] * 1000).toFixed(num_decimales_mini) + '</td><td>' +
        parseFloat(pt.ellips.axes[2][1]).toFixed(num_decimales) + '</td><td>' +
        parseFloat(pt.ellips.axes[2][2]).toFixed(num_decimales) + '</td>');
      items.push('</tr>');
    }
  }
  $('<table/>', {
    'class': 'points',
    html: items.join('')
  }).appendTo('#rapport');
}
function show_intervalles(){
  //write sigmas ------------------------------------------------------------------------------------
  $("<p/>").html('<a href="#interv">' + _('Intervalles de confiance') + '</a>').appendTo('#sommaire');
  $("<h2/>", {
    text: _('Intervalles de confiance'),
    id: 'interv',
    title: _('Intervalles de confiance 1D à 1 𝜎 (68%)')
  }).appendTo('#rapport');
  $("<a/>", {
    href: '#top'
  }).html('&#8593;').appendTo('#interv');
  items = ["<tr><th class=\"name\">" + _("Nom") +
    "</th><th>" + _("&sigma;X (mm)") +
    "</th><th>" + _("&sigma;Y (mm)") +
    "</th><th>" + _("&sigma;Z (mm)") +
    "</th></tr>"
  ];
  for (var i = 0; i < all_pts.length; i++) {
    var pt = all_pts[i];
    //Points 1D == Z
    if (pt.code === 4 || pt.code === 5) {
      items.push('<tr class=\"' + parite[i % 2] + '\"><td class=\"name\">' + pt.name + '</td>');
      items.push('<td>-</td><td>-</td><td>' +
        parseFloat(pt.ellips.sigmas[0] * 1000).toFixed(num_decimales_mini) + '</td>');
      items.push('</tr>');
    } else {
      items.push('<tr class=\"' + parite[i % 2] + '\"><td class=\"name\">' + pt.name + '</td>');
      items.push('<td>' +
        parseFloat(pt.ellips.sigmas[0] * 1000).toFixed(num_decimales_mini) + '</td><td>' +
        parseFloat(pt.ellips.sigmas[1] * 1000).toFixed(num_decimales_mini) + '</td><td>' +
        parseFloat(pt.ellips.sigmas[2] * 1000).toFixed(num_decimales_mini) + '</td>');
      items.push('</tr>');
    }
  }
  $('<table/>', {
    'class': 'points',
    html: items.join('')
  }).appendTo('#rapport');
}
function show_deplacements(){
  //Simulation des déplacements des points (Monte-Carlo) ------------------------------------------------------------------------------------
  $("<p/>").html('<a href="#deplacements">' + _('Simulation des déplacements des points') + '</a>').appendTo('#sommaire');
  $("<h2/>", {
    text: _('Simulation des déplacements des points'),
    id: 'deplacements'
  }).appendTo('#rapport');
  $("<a/>", {
    href: '#top'
  }).html('&#8593;').appendTo('#deplacements');
  $("<p/>", {
    text: _('Pour ') + parseInt(data["computation"]["nbr_iterations"]) + _(' simulations :')
  }).appendTo('#rapport');
  items = ["<tr><th class=\"name\">" + _("Nom") +
  "</th><th>" + _("EMQ X (mm)") +
  "</th><th>" + _("EMQ Y (mm)") +
  "</th><th>" + _("EMQ Z (mm)") +
  "</th>><th>" + _("Max X (mm)") +
  "</th>><th>" + _("Max Y (mm)") +
  "</th>><th>" + _("Max Z (mm)") + "</th></tr>"];
  for (var i = 0; i < all_pts.length; i++) {
    var pt = all_pts[i];
    items.push('<tr class=\"' + parite[i % 2] + '\"><td class=\"name\">' + pt.name + '</td>');
    items.push('<td>' +
      parseFloat(pt.MC_shift_sq_average[0] * 1000).toFixed(num_decimales_mini) + '</td><td>' +
      parseFloat(pt.MC_shift_sq_average[1] * 1000).toFixed(num_decimales_mini) + '</td><td>' +
      parseFloat(pt.MC_shift_sq_average[2] * 1000).toFixed(num_decimales_mini) + '</td><td>' +
      parseFloat(pt.MC_shift_max[0] * 1000).toFixed(num_decimales_mini) + '</td><td>' +
      parseFloat(pt.MC_shift_max[1] * 1000).toFixed(num_decimales_mini) + '</td><td>' +
      parseFloat(pt.MC_shift_max[2] * 1000).toFixed(num_decimales_mini) + '</td>'
    );
    items.push('</tr>');
  }
  $('<table/>', {
    'class': 'points',
    html: items.join('')
  }).appendTo('#rapport');
}
function show_footer(){
  //Pied de page ------------------------------------------------------------------------------------
  $("<p/>", {
    text: 'Copyright © 2013-2018 - IGN/SGN/Travaux Spéciaux - travaux.speciaux@ign.fr',
    class: 'footer'
  }).appendTo('#rapport');
}
//------------------------------------------------------------------------------
// Fonctions de lancement de l'écriture des différentes parties si c'est nécessaire
//------------------------------------------------------------------------------
function showComp3Djson(data) {
  num_decimales = parseInt(data["config"]["nb_digits"]);
  num_decimales_mini = Math.max(num_decimales - 3, 0);
  var lang = data["config"]["lang"];
  if (lang in translations)
    current_dict= translations[lang];
  if (data["points"])
  {
    $.each(data["points"], function(key, val) {
      all_pts.push(val);
      $(all_pts).get(-1).name = key;
      if (val["stations"]) {
        $.each(val["stations"], function(key2, val2) {
          $.each(val2["observations"], function(key3, val3) {
            if (!(val3.active&&(val3.rank<0))) all_obs.push(val3); //ne pas afficher les obs non utilisees
          });
          if (val2["type"] === "bascule") {
            all_basc.push(val2);
            $(all_basc).get(-1).name = key;
            $(all_basc).get(-1).origin = val;
          }
        });
      }
    });
  }

  if (data["computation"])
  {
    if (data["computation"]["ICobs"])
    {
      $.each(data["computation"]["ICobs"], function(key, val) {
        all_obs.push(val);
      });
    }
  }

  all_pts.sort(pointSortFunction);
  all_obs.sort(obsSortFunction);
  all_files = data["all_data_files"];

  show_version();
  $('<div id="sommaire" /div>').appendTo('body');
  $("<h2 >"+_('Sommaire')+"</h2>").appendTo('#sommaire');
  $('<div id="rapport" /div>').appendTo('body');
  show_info_work();
  show_info_calc();
  if ((data["config"]["compute_type"] === 0) && (data["computation"]["compensationDone"] || data["computation"]["asked_to_stop"])) {
    show_evol_sigma0();
    show_chi2();
  }
  show_coord_init();
  show_obs();
  if (data["config"]["compute_type"] === 0) {
    show_repart_residuals();
    show_biggest_residuals();
  }
  if (all_basc.length > 0) {
    show_bascules();
  }
  if ((data["computation"]["compensationDone"] || data["computation"]["asked_to_stop"]) && (data["config"]["compute_type"] === 0)) {
    show_coord_comp();
  }
  if (data["computation"]["invertedMatrix"]) {
    show_ellips();
    show_intervalles();
  }
  if (data["config"]["compute_type"] === 2) {
    show_deplacements();
  }
  show_footer();
}

$(document).ready(function() {
  showComp3Djson(data);
});
